openapi: 3.0.3
info:
  title: Restarter API
  version: "0.3.0"
  description: |
    REST API for the ESP32-C3 PC Restarter.
    
    ## Authentication
    
    Protected endpoints require HTTP Basic Auth:
    - Username: `admin`
    - Password: Device-unique (shown on first boot)
    
    ## CSRF Protection
    
    All POST requests (except in AP mode) require a CSRF token:
    - Get token from `GET /api/status` response (`csrfToken` field)
    - Send via `X-CSRF-Token` header or `csrfToken` in JSON body
    
    ## Integrations
    
    | Integration | Endpoint | Description |
    |-------------|----------|-------------|
    | REST API | `/api/*` | This specification |
    | WebSocket | `/ws` | Real-time status updates |
    | Prometheus | `/metrics` | Metrics scraping |
    | MQTT | External | Home Assistant auto-discovery |
    | Loki | External | Log shipping |

servers:
  - url: http://{device_host}
    description: ESP32 device on LAN or AP mode (192.168.4.1)
    variables:
      device_host:
        default: restarter-abc123.local

tags:
  - name: Status
    description: Device status and health
  - name: Configuration
    description: Device settings
  - name: Actions
    description: PC control actions
  - name: Network
    description: WiFi management
  - name: Monitoring
    description: Prometheus metrics

paths:
  /api/status:
    get:
      tags: [Status]
      summary: Get device status
      description: |
        Returns current device state, WiFi info, system stats, and CSRF token.
        No authentication required.
      responses:
        "200":
          description: Status payload
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Status"

  /api/config:
    get:
      tags: [Configuration]
      summary: Get configuration
      description: Returns current configuration. Passwords are hidden.
      security:
        - basicAuth: []
      responses:
        "200":
          description: Current config
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Config"
        "401":
          description: Authentication required
    post:
      tags: [Configuration]
      summary: Save configuration
      description: |
        Saves configuration and restarts device.
        Requires authentication and CSRF token (in STA mode).
      security:
        - basicAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ConfigUpdate"
      responses:
        "200":
          description: Saved successfully, device restarting
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Ok"
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Authentication required
        "403":
          description: CSRF token invalid
        "500":
          description: Save failed

  /api/action/power:
    post:
      tags: [Actions]
      summary: Press power button
      description: Simulates pressing the power button for configured duration.
      security:
        - basicAuth: []
      parameters:
        - $ref: "#/components/parameters/CsrfToken"
      responses:
        "200":
          description: Action executed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Ok"
        "401":
          description: Authentication required
        "403":
          description: CSRF token invalid
        "429":
          description: Rate limited

  /api/action/reset:
    post:
      tags: [Actions]
      summary: Press reset button
      description: Simulates pressing the reset button for configured duration.
      security:
        - basicAuth: []
      parameters:
        - $ref: "#/components/parameters/CsrfToken"
      responses:
        "200":
          description: Action executed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Ok"
        "401":
          description: Authentication required
        "403":
          description: CSRF token invalid

  /api/action/force-power:
    post:
      tags: [Actions]
      summary: Force power off
      description: Holds power button for 11 seconds to force shutdown.
      security:
        - basicAuth: []
      parameters:
        - $ref: "#/components/parameters/CsrfToken"
      responses:
        "200":
          description: Action executed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Ok"
        "401":
          description: Authentication required
        "403":
          description: CSRF token invalid

  /api/wifi/scan:
    get:
      tags: [Network]
      summary: Scan WiFi networks
      description: Initiates or returns WiFi network scan results.
      responses:
        "200":
          description: Scan complete
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WifiScanResults"
        "202":
          description: Scan in progress
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WifiScanInProgress"

  /api/factory-reset:
    post:
      tags: [Configuration]
      summary: Factory reset
      description: Clears all configuration and restarts in AP mode.
      security:
        - basicAuth: []
      parameters:
        - $ref: "#/components/parameters/CsrfToken"
      responses:
        "200":
          description: Reset initiated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Ok"
        "401":
          description: Authentication required
        "403":
          description: CSRF token invalid

  /metrics:
    get:
      tags: [Monitoring]
      summary: Prometheus metrics
      description: |
        Returns device metrics in Prometheus text exposition format.
        
        Available metrics:
        - `restarter_info` - Device information
        - `restarter_pc_state` - PC state (0=OFF, 1=BOOTING, 2=RUNNING, 3=RESTARTING)
        - `restarter_pc_power` - PC power (0=OFF, 1=ON)
        - `restarter_temperature_celsius` - Temperature
        - `restarter_wifi_rssi` - WiFi signal strength (dBm)
        - `restarter_heap_free_bytes` - Free heap memory
        - `restarter_uptime_seconds` - Device uptime
      responses:
        "200":
          description: Prometheus metrics
          content:
            text/plain:
              schema:
                type: string
              example: |
                # HELP restarter_pc_power PC power state
                # TYPE restarter_pc_power gauge
                restarter_pc_power{device="abc123",hostname="restarter-abc123"} 1

components:
  securitySchemes:
    basicAuth:
      type: http
      scheme: basic
      description: Username "admin", password is device-unique

  parameters:
    CsrfToken:
      name: X-CSRF-Token
      in: header
      description: CSRF token from /api/status response
      required: true
      schema:
        type: string

  schemas:
    Status:
      type: object
      properties:
        type:
          type: string
          example: status
        hostname:
          type: string
          example: restarter-abc123
        deviceId:
          type: string
          example: a1b2c3d4e5f6
        apMode:
          type: boolean
          description: True in Access Point mode
        wifiConnected:
          type: boolean
        hasConfig:
          type: boolean
        pcState:
          type: string
          enum: [OFF, BOOTING, RUNNING, RESTARTING]
        powerRelayActive:
          type: boolean
        resetRelayActive:
          type: boolean
        temperature:
          type: number
          format: float
        hddLastActiveSec:
          type: integer
          description: Seconds since HDD activity (-1 = never)
        ssid:
          type: string
        ip:
          type: string
        rssi:
          type: integer
          description: WiFi signal (dBm)
        freeHeap:
          type: integer
        totalHeap:
          type: integer
        cpuLoad:
          type: integer
          description: CPU load percentage
        csrfToken:
          type: string
          description: CSRF token for POST requests (STA mode only)
        apPassword:
          type: string
          description: AP password (AP mode only)

    Config:
      type: object
      properties:
        wifiSsid:
          type: string
        hasWifiPass:
          type: boolean
        mqtt:
          $ref: "#/components/schemas/IntegrationMqtt"
        loki:
          $ref: "#/components/schemas/IntegrationLoki"
        prometheus:
          $ref: "#/components/schemas/IntegrationPrometheus"
        powerPulseMs:
          type: integer
        resetPulseMs:
          type: integer
        bootGraceMs:
          type: integer
        hasCustomAdminPass:
          type: boolean

    IntegrationMqtt:
      type: object
      properties:
        host:
          type: string
          example: mqtt.local
        port:
          type: integer
          example: 1883
        user:
          type: string
        hasPass:
          type: boolean
        tls:
          type: boolean
        enabled:
          type: boolean

    IntegrationLoki:
      type: object
      properties:
        host:
          type: string
          example: http://loki.local:3100
        user:
          type: string
        hasPass:
          type: boolean
        enabled:
          type: boolean

    IntegrationPrometheus:
      type: object
      properties:
        enabled:
          type: boolean
          example: true
        endpoint:
          type: string
          example: /metrics

    ConfigUpdate:
      type: object
      required:
        - wifiSsid
      properties:
        wifiSsid:
          type: string
        wifiPass:
          type: string
          description: Empty = keep existing
        mqtt:
          $ref: "#/components/schemas/IntegrationMqttUpdate"
        loki:
          $ref: "#/components/schemas/IntegrationLokiUpdate"
        powerPulseMs:
          type: integer
        resetPulseMs:
          type: integer
        bootGraceMs:
          type: integer
        adminPassword:
          type: string
          description: Empty = keep existing
        csrfToken:
          type: string
          description: Required in STA mode

    IntegrationMqttUpdate:
      type: object
      properties:
        host:
          type: string
        port:
          type: integer
        user:
          type: string
        pass:
          type: string
          description: Empty = keep existing
        tls:
          type: boolean

    IntegrationLokiUpdate:
      type: object
      properties:
        host:
          type: string
        user:
          type: string
        pass:
          type: string
          description: Empty = keep existing

    WifiScanResults:
      type: object
      properties:
        networks:
          type: array
          items:
            $ref: "#/components/schemas/WifiNetwork"

    WifiScanInProgress:
      type: object
      properties:
        scanning:
          type: boolean
          example: true

    WifiNetwork:
      type: object
      properties:
        ssid:
          type: string
        rssi:
          type: integer
        secure:
          type: boolean

    Ok:
      type: object
      properties:
        ok:
          type: boolean
          example: true

    Error:
      type: object
      properties:
        error:
          type: string
          example: wifiSsid required