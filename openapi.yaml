openapi: 3.0.3
info:
  title: Restarter API
  version: "0.2.0"
  description: REST API for the ESP32-C3 PC Restarter with onboarding support.
servers:
  - url: http://{device_host}
    description: ESP32 device on your LAN or AP mode
    variables:
      device_host:
        default: 192.168.4.1
paths:
  /api/status:
    get:
      summary: Get device status
      description: Returns current device state, WiFi info, and system stats.
      responses:
        "200":
          description: Status payload
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Status"
  /api/config:
    get:
      summary: Get config (no passwords)
      description: Returns current configuration without sensitive data.
      responses:
        "200":
          description: Current config
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Config"
    post:
      summary: Save config and reboot
      description: Saves WiFi, MQTT, and timing configuration. Device reboots after save.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ConfigUpdate"
      responses:
        "200":
          description: Saved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Ok"
        "400":
          description: Validation error (wifiSsid required)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Save failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  /api/action/power:
    post:
      summary: Pulse power relay
      description: Simulates pressing the power button for configured duration.
      responses:
        "200":
          description: Accepted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Ok"
  /api/action/reset:
    post:
      summary: Pulse reset relay
      description: Simulates pressing the reset button for configured duration.
      responses:
        "200":
          description: Accepted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Ok"
  /api/action/force-power:
    post:
      summary: Force power off (11s hold)
      description: Holds power relay for 11 seconds to force shutdown.
      responses:
        "200":
          description: Accepted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Ok"
  /api/wifi/scan:
    get:
      summary: Scan for WiFi networks
      description: Initiates or returns WiFi network scan results.
      responses:
        "200":
          description: Scan results
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WifiScanResults"
        "202":
          description: Scan in progress
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WifiScanInProgress"
  /api/factory-reset:
    post:
      summary: Factory reset device
      description: Clears all configuration and restarts device in AP mode for fresh setup.
      security:
        - basicAuth: []
      parameters:
        - name: X-CSRF-Token
          in: header
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Reset initiated, device will restart
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Ok"
  /metrics:
    get:
      summary: Prometheus metrics
      description: Returns device metrics in Prometheus text exposition format.
      responses:
        "200":
          description: Prometheus metrics
          content:
            text/plain:
              schema:
                type: string
                example: |
                  # HELP restarter_pc_power PC power state
                  # TYPE restarter_pc_power gauge
                  restarter_pc_power{device="abc123"} 1
components:
  securitySchemes:
    basicAuth:
      type: http
      scheme: basic
      description: Username is "admin", password is device-unique
  schemas:
    Status:
      type: object
      properties:
        type:
          type: string
          example: status
        hostname:
          type: string
          example: restarter-a1b2c3
        deviceId:
          type: string
          example: a1b2c3d4e5f6
        apMode:
          type: boolean
          description: True when device is in Access Point mode
        wifiConnected:
          type: boolean
        hasConfig:
          type: boolean
          description: True if WiFi SSID is configured
        pcState:
          type: string
          enum: [OFF, BOOTING, RUNNING, RESTARTING, UNKNOWN]
        powerRelayActive:
          type: boolean
        resetRelayActive:
          type: boolean
        temperature:
          type: number
          format: float
          description: Temperature in Celsius from TMP112
        hddLastActiveSec:
          type: integer
          description: Seconds since last HDD activity (-1 = never)
        ssid:
          type: string
        ip:
          type: string
        rssi:
          type: integer
          description: WiFi signal strength in dBm
        freeHeap:
          type: integer
          description: Free heap memory in bytes
        totalHeap:
          type: integer
          description: Total heap memory in bytes
        cpuLoad:
          type: integer
          description: Approximate CPU load percentage
    Config:
      type: object
      properties:
        wifiSsid:
          type: string
        hasWifiPass:
          type: boolean
        mqtt:
          $ref: "#/components/schemas/MqttConfig"
        loki:
          $ref: "#/components/schemas/LokiConfig"
        prometheus:
          $ref: "#/components/schemas/PrometheusConfig"
        powerPulseMs:
          type: integer
          description: Power button pulse duration in ms
        resetPulseMs:
          type: integer
          description: Reset button pulse duration in ms
        bootGraceMs:
          type: integer
          description: Boot grace period before state detection in ms
        hasCustomAdminPass:
          type: boolean
          description: True if user changed the default admin password
    MqttConfig:
      type: object
      properties:
        host:
          type: string
          example: mqtt.local
        port:
          type: integer
          example: 1883
        user:
          type: string
        hasPass:
          type: boolean
        tls:
          type: boolean
        enabled:
          type: boolean
    LokiConfig:
      type: object
      properties:
        host:
          type: string
          example: http://loki.local:3100
        user:
          type: string
        hasPass:
          type: boolean
        enabled:
          type: boolean
    PrometheusConfig:
      type: object
      properties:
        enabled:
          type: boolean
          example: true
        endpoint:
          type: string
          example: /metrics
    ConfigUpdate:
      type: object
      required:
        - wifiSsid
      properties:
        wifiSsid:
          type: string
        wifiPass:
          type: string
          description: Leave empty to preserve existing password
        mqtt:
          $ref: "#/components/schemas/MqttConfigUpdate"
        loki:
          $ref: "#/components/schemas/LokiConfigUpdate"
        powerPulseMs:
          type: integer
        resetPulseMs:
          type: integer
        bootGraceMs:
          type: integer
        adminPassword:
          type: string
          description: Leave empty to preserve existing password
        csrfToken:
          type: string
          description: Required in STA mode for CSRF protection
    MqttConfigUpdate:
      type: object
      properties:
        host:
          type: string
        port:
          type: integer
        user:
          type: string
        pass:
          type: string
          description: Leave empty to preserve existing password
        tls:
          type: boolean
    LokiConfigUpdate:
      type: object
      properties:
        host:
          type: string
          example: http://loki.local:3100
        user:
          type: string
        pass:
          type: string
          description: Leave empty to preserve existing password
    WifiScanResults:
      type: object
      properties:
        networks:
          type: array
          items:
            $ref: "#/components/schemas/WifiNetwork"
    WifiScanInProgress:
      type: object
      properties:
        scanning:
          type: boolean
          example: true
    WifiNetwork:
      type: object
      properties:
        ssid:
          type: string
        rssi:
          type: integer
          description: Signal strength in dBm
        secure:
          type: boolean
          description: True if network requires password
    Ok:
      type: object
      properties:
        ok:
          type: boolean
    Error:
      type: object
      properties:
        error:
          type: string
